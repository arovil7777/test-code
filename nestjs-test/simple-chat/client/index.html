<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>채팅 앱</title>
    <link href="./style.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <div class="container">
        <h1>Socket.io 채팅 앱</h1>
        <p>내 닉네임: <span id="random-animal-name"></span></p>
        <div class="rooms" id="rooms-container">
            <div class="room" id="room">
                <header>
                    <h2>ROOM</h2>
                    <div class="button-container">
                        <button onclick="joinRoom('room')">입장</button>
                        <button onclick="exitRoom('room')">퇴장</button>
                    </div>
                </header>
                <div class="users" id="room-users"></div>
                <div class="chat-container" id="room-chat-container">
                    <ul class="chat-list" id="room-chat-list"></ul>
                </div>
                <div class="chat-input">
                    <input type="text" class="room-message-input" id="room-message-input" placeholder="메시지를 입력하세요."
                        onkeyup="sendMessage(event, 'room')" />
                    <button onclick="sendRoomMessage('room')">보내기</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
    <script>
        const socket = io();

        const roomUsers = document.getElementById('room-users');
        const roomChatList = document.getElementById('room-chat-list');
        const roomChatContainer = document.getElementById('room-chat-container');
        const roomMessageInput = document.getElementById('room-message-input');

        // 임의의 닉네임 지정 (동물)
        const animalNames = [
            '사자', '낙타', '고양이', '직바오', '침바오',
            '사슴', '호랑이', '늑대', '여우', '닭',
            '곰', '쥐', '나무늘보', '침팬지', '까마귀',
            '비둘기', '캥거루', '강아지', '악어', '고래', '상어'
        ];

        const getRandomAnimalName = animalNames[Math.floor(Math.random() * animalNames.length)] + '-' + Math.floor(Math.random() * 100).toString();
        socket.emit('setUserNick', getRandomAnimalName);

        const joinRoom = (room) => {
            socket.emit('join', room);
        }

        const exitRoom = (room) => {
            if (!room) return;

            roomUsers.innerHTML = '';
            roomChatList.innerHTML = '';
            socket.emit('exit', room);
        }

        const sendRoomMessage = (room) => {
            const message = roomMessageInput.value.trim();

            if (message.trim() !== '') {
                socket.emit('chatMessage', { message, room });
                roomMessageInput.value = '';
            }
        }

        const appendMessage = (room, message) => {
            const chatList = roomChatList;
            const li = document.createElement('li');
            li.className = 'chat-item';
            const p = document.createElement('p');
            p.textContent = message;
            li.appendChild(p);
            chatList.appendChild(li);

            roomChatContainer.scrollTop = roomChatContainer.scrollHeight;
        }

        const sendMessage = (event, room) => {
            if (event.key === 'Enter') sendRoomMessage(room);
        }

        socket.on('userList', ({ room, userList }) => {
            if (!room) return;

            const usersElement = roomUsers;
            usersElement.innerHTML = '';
            userList.forEach((userId) => {
                const p = document.createElement('p');
                p.textContent = userId;
                usersElement.appendChild(p);
            });
        });

        socket.on('userJoined', ({ userId, room }) => {
            appendMessage(room, `${userId}님이 방에 입장했습니다.`);
        });

        socket.on('userLeft', ({ userId, room }) => {
            appendMessage(room, `${userId}님이 방을 떠났습니다.`);
        });

        socket.on('chatMessage', ({ userId, message, room }) => {
            appendMessage(room, `${userId} : ${message}`);
        });

        socket.on('joinError', (errorMessage) => {
            alert(errorMessage);
        })

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('random-animal-name').innerHTML = getRandomAnimalName;
        });
    </script>
</body>

</html>